'use strict';

// Visualization constructor
// TODO Lines length can be corrected via reducing frames.total
// TODO Refactor sprite config objects
// TODO All possible sprites should be predefined
TRIPLET.Picture = function () {

  var cfg = TRIPLET.config.general,
      random = TRIPLET.utilities.random,
      elem = TRIPLET.config.element,
      Sprite = TRIPLET.Sprite,
      Picture;

  Picture = function Picture(field, canvas) {
    this.field = field;
    this.canvas = canvas;
    this.context = this.canvas.getContext('2d');
    this.sprites = [];
  };

  Picture.prototype = {

    constructor: Picture,

    drawSprite: function drawSprite(sprite) {

      function clearCanvas() {
        this.context.setTransform(1, 0, 0, 1, 0, 0);
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
      }

      function draw(sp) {
        this.context.setTransform(1, 0, 0, 1, 0, 0);
        this.context.translate(sp.center.x, sp.center.y);
        this.context.rotate(sp.angle);
        this.context.scale(sp.scale.width, sp.scale.height);
        this.context.drawImage(sp.image, sp.frames.width * (sp.frames.current % sp.frames.inRow), sp.frames.height * ~ ~(sp.frames.current / sp.frames.inRow), sp.frames.width, sp.frames.height, sp.dx, sp.dy, sp.width, sp.height);
      }

      if (!(sprite instanceof Sprite)) throw new TypeError('Argument is not Sprite: ' + sprite);
      if (! ~sprite.frames.current) this.sprites.push(sprite);
      if (sprite.frames.total - 1 > ++sprite.frames.current) setTimeout(this.drawSprite.bind(this, sprite), sprite.frames.delay);
      clearCanvas.call(this);
      this.sprites.forEach(draw, this);
    },

    drawField: function drawField(lineID) {
      lineID = lineID || 0;
      var line = this.field.lines.visible[lineID];
      if (line) {
        setTimeout(this.drawField.bind(this, lineID + 1), elem.line.pause);
        this.drawSprite(new Sprite({
          imgID: elem.line.random.imgID,
          color: elem.line.color,
          frames: elem.line.frames,
          container: this.field,
          center: { x: line.x, y: line.y },
          angle: line.angle,
          scale: {
            width: random.sign() + elem.line.random.scale,
            height: random.sign() * cfg.defaultRowsCols / Math.max(cfg.rows, cfg.columns) + elem.line.random.scale
          }
        }));
      }
    },

    drawSign: function drawSign(row, col, player) {
      var cellCenter = this.field.getCellCenter(row, col);
      cellCenter.x += elem.sign.random.move;
      cellCenter.y += elem.sign.random.move;
      this.drawSprite(new Sprite({
        imgID: elem.sign.random.imgID[player.signID],
        color: player.color || elem.sign.color,
        frames: elem.sign.frames,
        container: this.field.cell,
        center: cellCenter,
        angle: elem.sign.random.rotate,
        scale: {
          width: random.sign() + elem.sign.random.scale,
          height: random.sign() + elem.sign.random.scale
        }
      }));
    }

  };

  return Picture;
}();
//# sourceMappingURL=data:application/json;base64,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LENBQWlCLElBQWpDO0FBQ0EsV0FBSyxVQUFMLENBQWdCLElBQUksTUFBSixDQUFXO0FBQ3pCLGVBQU8sS0FBSyxJQUFMLENBQVUsTUFBVixDQUFpQixLQUFqQixDQUF1QixPQUFPLE1BQTlCLENBRGtCO0FBRXpCLGVBQU8sT0FBTyxLQUFQLElBQWdCLEtBQUssSUFBTCxDQUFVLEtBRlI7QUFHekIsZ0JBQVEsS0FBSyxJQUFMLENBQVUsTUFITztBQUl6QixtQkFBVyxLQUFLLEtBQUwsQ0FBVyxJQUpHO0FBS3pCLGdCQUFRLFVBTGlCO0FBTXpCLGVBQU8sS0FBSyxJQUFMLENBQVUsTUFBVixDQUFpQixNQU5DO0FBT3pCLGVBQU87QUFDTCxpQkFBTyxPQUFPLElBQVAsS0FBZ0IsS0FBSyxJQUFMLENBQVUsTUFBVixDQUFpQixLQURuQztBQUVMLGtCQUFRLE9BQU8sSUFBUCxLQUFnQixLQUFLLElBQUwsQ0FBVSxNQUFWLENBQWlCO0FBRnBDO0FBUGtCLE9BQVgsQ0FBaEI7QUFZRDs7QUEzRWlCLEdBQXBCOztBQStFQSxTQUFPLE9BQVA7QUFFQyxDQWhHaUIsRUFBbEIiLCJmaWxlIjoianMvcGljdHVyZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFZpc3VhbGl6YXRpb24gY29uc3RydWN0b3JcclxuLy8gVE9ETyBMaW5lcyBsZW5ndGggY2FuIGJlIGNvcnJlY3RlZCB2aWEgcmVkdWNpbmcgZnJhbWVzLnRvdGFsXHJcbi8vIFRPRE8gUmVmYWN0b3Igc3ByaXRlIGNvbmZpZyBvYmplY3RzXHJcbi8vIFRPRE8gQWxsIHBvc3NpYmxlIHNwcml0ZXMgc2hvdWxkIGJlIHByZWRlZmluZWRcclxuVFJJUExFVC5QaWN0dXJlID0gKGZ1bmN0aW9uKCkge1xyXG5cclxudmFyIGNmZyA9IFRSSVBMRVQuY29uZmlnLmdlbmVyYWwsXHJcbiAgICByYW5kb20gPSBUUklQTEVULnV0aWxpdGllcy5yYW5kb20sXHJcbiAgICBlbGVtID0gVFJJUExFVC5jb25maWcuZWxlbWVudCxcclxuICAgIFNwcml0ZSA9IFRSSVBMRVQuU3ByaXRlLFxyXG4gICAgUGljdHVyZTtcclxuXHJcblBpY3R1cmUgPSBmdW5jdGlvbihmaWVsZCwgY2FudmFzKSB7XHJcbiAgdGhpcy5maWVsZCA9IGZpZWxkO1xyXG4gIHRoaXMuY2FudmFzID0gY2FudmFzO1xyXG4gIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJyk7XHJcbiAgdGhpcy5zcHJpdGVzID0gW107XHJcbn07XHJcblxyXG5QaWN0dXJlLnByb3RvdHlwZSA9IHtcclxuXHJcbiAgY29uc3RydWN0b3I6IFBpY3R1cmUsXHJcblxyXG4gIGRyYXdTcHJpdGU6IGZ1bmN0aW9uKHNwcml0ZSkge1xyXG5cclxuICAgIGZ1bmN0aW9uIGNsZWFyQ2FudmFzKCkge1xyXG4gICAgICB0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApO1xyXG4gICAgICB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMuY2FudmFzLndpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGRyYXcoc3ApIHtcclxuICAgICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTtcclxuICAgICAgdGhpcy5jb250ZXh0LnRyYW5zbGF0ZShzcC5jZW50ZXIueCwgc3AuY2VudGVyLnkpO1xyXG4gICAgICB0aGlzLmNvbnRleHQucm90YXRlKHNwLmFuZ2xlKTtcclxuICAgICAgdGhpcy5jb250ZXh0LnNjYWxlKHNwLnNjYWxlLndpZHRoLCBzcC5zY2FsZS5oZWlnaHQpO1xyXG4gICAgICB0aGlzLmNvbnRleHQuZHJhd0ltYWdlKFxyXG4gICAgICAgICAgc3AuaW1hZ2UsXHJcbiAgICAgICAgICBzcC5mcmFtZXMud2lkdGggKiAoc3AuZnJhbWVzLmN1cnJlbnQgJSBzcC5mcmFtZXMuaW5Sb3cpLFxyXG4gICAgICAgICAgc3AuZnJhbWVzLmhlaWdodCAqIH5+KHNwLmZyYW1lcy5jdXJyZW50IC8gc3AuZnJhbWVzLmluUm93KSxcclxuICAgICAgICAgIHNwLmZyYW1lcy53aWR0aCxcclxuICAgICAgICAgIHNwLmZyYW1lcy5oZWlnaHQsXHJcbiAgICAgICAgICBzcC5keCxcclxuICAgICAgICAgIHNwLmR5LFxyXG4gICAgICAgICAgc3Aud2lkdGgsXHJcbiAgICAgICAgICBzcC5oZWlnaHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghKHNwcml0ZSBpbnN0YW5jZW9mIFNwcml0ZSkpXHJcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IGlzIG5vdCBTcHJpdGU6ICcgKyBzcHJpdGUpO1xyXG4gICAgaWYgKCF+c3ByaXRlLmZyYW1lcy5jdXJyZW50KSB0aGlzLnNwcml0ZXMucHVzaChzcHJpdGUpO1xyXG4gICAgaWYgKHNwcml0ZS5mcmFtZXMudG90YWwgLSAxID4gKytzcHJpdGUuZnJhbWVzLmN1cnJlbnQpXHJcbiAgICAgIHNldFRpbWVvdXQodGhpcy5kcmF3U3ByaXRlLmJpbmQodGhpcywgc3ByaXRlKSwgc3ByaXRlLmZyYW1lcy5kZWxheSk7XHJcbiAgICBjbGVhckNhbnZhcy5jYWxsKHRoaXMpO1xyXG4gICAgdGhpcy5zcHJpdGVzLmZvckVhY2goZHJhdywgdGhpcyk7XHJcblxyXG4gIH0sXHJcblxyXG4gIGRyYXdGaWVsZDogZnVuY3Rpb24obGluZUlEKSB7XHJcbiAgICBsaW5lSUQgPSBsaW5lSUQgfHwgMDtcclxuICAgIHZhciBsaW5lID0gdGhpcy5maWVsZC5saW5lcy52aXNpYmxlW2xpbmVJRF07XHJcbiAgICBpZiAobGluZSkge1xyXG4gICAgICBzZXRUaW1lb3V0KHRoaXMuZHJhd0ZpZWxkLmJpbmQodGhpcywgbGluZUlEICsgMSksIGVsZW0ubGluZS5wYXVzZSk7XHJcbiAgICAgIHRoaXMuZHJhd1Nwcml0ZShuZXcgU3ByaXRlKHtcclxuICAgICAgICBpbWdJRDogZWxlbS5saW5lLnJhbmRvbS5pbWdJRCxcclxuICAgICAgICBjb2xvcjogZWxlbS5saW5lLmNvbG9yLFxyXG4gICAgICAgIGZyYW1lczogZWxlbS5saW5lLmZyYW1lcyxcclxuICAgICAgICBjb250YWluZXI6IHRoaXMuZmllbGQsXHJcbiAgICAgICAgY2VudGVyOiB7IHg6IGxpbmUueCwgeTogbGluZS55IH0sXHJcbiAgICAgICAgYW5nbGU6IGxpbmUuYW5nbGUsXHJcbiAgICAgICAgc2NhbGU6IHtcclxuICAgICAgICAgIHdpZHRoOiByYW5kb20uc2lnbigpICsgZWxlbS5saW5lLnJhbmRvbS5zY2FsZSxcclxuICAgICAgICAgIGhlaWdodDogcmFuZG9tLnNpZ24oKSAqIGNmZy5kZWZhdWx0Um93c0NvbHMgL1xyXG4gICAgICAgICAgICAgIE1hdGgubWF4KGNmZy5yb3dzLCBjZmcuY29sdW1ucykgKyBlbGVtLmxpbmUucmFuZG9tLnNjYWxlXHJcbiAgICAgICAgfVxyXG4gICAgICB9KSk7XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgZHJhd1NpZ246IGZ1bmN0aW9uKHJvdywgY29sLCBwbGF5ZXIpIHtcclxuICAgIHZhciBjZWxsQ2VudGVyID0gdGhpcy5maWVsZC5nZXRDZWxsQ2VudGVyKHJvdywgY29sKTtcclxuICAgIGNlbGxDZW50ZXIueCArPSBlbGVtLnNpZ24ucmFuZG9tLm1vdmU7XHJcbiAgICBjZWxsQ2VudGVyLnkgKz0gZWxlbS5zaWduLnJhbmRvbS5tb3ZlO1xyXG4gICAgdGhpcy5kcmF3U3ByaXRlKG5ldyBTcHJpdGUoe1xyXG4gICAgICBpbWdJRDogZWxlbS5zaWduLnJhbmRvbS5pbWdJRFtwbGF5ZXIuc2lnbklEXSxcclxuICAgICAgY29sb3I6IHBsYXllci5jb2xvciB8fCBlbGVtLnNpZ24uY29sb3IsXHJcbiAgICAgIGZyYW1lczogZWxlbS5zaWduLmZyYW1lcyxcclxuICAgICAgY29udGFpbmVyOiB0aGlzLmZpZWxkLmNlbGwsXHJcbiAgICAgIGNlbnRlcjogY2VsbENlbnRlcixcclxuICAgICAgYW5nbGU6IGVsZW0uc2lnbi5yYW5kb20ucm90YXRlLFxyXG4gICAgICBzY2FsZToge1xyXG4gICAgICAgIHdpZHRoOiByYW5kb20uc2lnbigpICsgZWxlbS5zaWduLnJhbmRvbS5zY2FsZSxcclxuICAgICAgICBoZWlnaHQ6IHJhbmRvbS5zaWduKCkgKyBlbGVtLnNpZ24ucmFuZG9tLnNjYWxlXHJcbiAgICAgIH1cclxuICAgIH0pKTtcclxuICB9XHJcblxyXG59O1xyXG5cclxucmV0dXJuIFBpY3R1cmU7XHJcblxyXG59KSgpO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
